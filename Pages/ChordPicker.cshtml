@page
@model ChordProgressionQuiz.Pages.ChordPickerModel
@{
    ViewData["Title"] = "Your Chord Progression";
}

<div class="text-center">
    <h1 class="display-4">Your Chord Progression</h1>
    @if (Model.RandomProgression != null)
    {
        <div class="card mt-4 mx-auto" style="max-width: 600px;">
            <div class="card-header bg-primary text-white rounded-top">
                <h4 class="mb-0">Song: @Model.RandomProgression.Song</h4>
            </div>
            <div class="card-body">
                <h5 class="card-title text-info">Keys Example: @Model.RandomProgression.KeysExample</h5>
                <p class="card-text">
                    <strong>Tonal:</strong> @Model.RandomProgression.Tonal?.RomanNumerals (relative to @Model.RandomProgression.Tonal?.RelativeTo)
                </p>
                @if (Model.RandomProgression.Modal != null && Model.RandomProgression.Modal.Any())
                {
                    <p class="card-text">
                        <strong>Modal:</strong>
                        @foreach (var modal in Model.RandomProgression.Modal)
                        {
                            <span>@modal.RomanNumerals (relative to @modal.RelativeTo)</span><br />
                        }
                    </p>
                }
                @if (Model.RandomProgression.SubstitutionGroup.HasValue)
                {
                    <p class="card-text"><strong>Substitution Group:</strong> @Model.RandomProgression.SubstitutionGroup</p>
                }
                @if (Model.RandomProgression.PalindromicGroup.HasValue)
                {
                    <p class="card-text"><strong>Palindromic Group:</strong> @Model.RandomProgression.PalindromicGroup</p>
                }
                @if (Model.RandomProgression.RotationGroup.HasValue)
                {
                    <p class="card-text"><strong>Rotation Group:</strong> @Model.RandomProgression.RotationGroup</p>
                }

                <hr />
                @* Display the absolute MIDI progression *@
                @if (Model.AbsoluteProgression != null && Model.AbsoluteProgression.Chords.Any())
                {
                    <h5 class="card-title text-success mt-3">Base MIDI Pitches:</h5>
                    <p class="card-text">
                        @foreach (var chord in Model.AbsoluteProgression.Chords)
                        {
                            <span>[@string.Join(", ", chord.MidiPitches)]</span>
                            @if (Model.AbsoluteProgression.Chords.IndexOf(chord) < Model.AbsoluteProgression.Chords.Count - 1)
                            {
                                <span> | </span>
                            }
                        }
                    </p>
                    <h5 class="card-title text-primary mt-3">Stylized Playback Details:</h5>
                    @if (Model.StylizedProgression != null && Model.StylizedProgression.MidiEvents.Any())
                    {
                        <p class="card-text">
                            Total MIDI Events: @Model.StylizedProgression.MidiEvents.Count
                            <br />
                            @* You could add more details here about the styling applied if desired *@
                        </p>
                    }
                    else
                    {
                        <p class="alert alert-info mt-3">No stylized playback data available.</p>
                    }

                    <button id="playMidiButton" class="btn btn-primary btn-lg mt-3">Play MIDI Progression</button>
                    <div id="loadingMessage" class="mt-2 text-muted" style="display:none;">Loading instruments...</div>
                }
                else
                {
                    <p class="alert alert-info mt-3">Could not generate MIDI pitches for this progression.</p>
                }
            </div>
        </div>
        <p class="mt-2">Progression @(Model.CurrentProgressionIndex + 1) of @(Model.ChordService.GetProgressionCount())</p>

    }
    else
    {
        <p class="alert alert-warning mt-4">No chord progression found. Please ensure the 'chordProgressions.json' file is correctly placed in the 'Data' folder and contains valid data.</p>
    }
    <div class="mt-4 d-flex justify-content-center align-items-center flex-wrap">
        @* Checkbox for stylized playback - now with onchange submit and no separate button *@
        <form method="post" asp-page-handler="ToggleStylizedPlayback" class="d-inline-flex align-items-center mx-2 my-1">
            <input type="hidden" asp-for="CurrentProgressionIndex" />
            <input type="checkbox" asp-for="EnableStylizedPlayback" onchange="this.form.submit()" class="form-check-input me-1" /> @* Re-added onchange *@
            <label asp-for="EnableStylizedPlayback" class="form-check-label">Enable Stylized Playback</label>
            @* Removed Apply button *@
        </form>

        @* Navigation Buttons *@
        <a asp-page="/ChordPicker" asp-route-EnableStylizedPlayback="@Model.EnableStylizedPlayback" class="btn btn-success btn-lg mx-2 my-1">Get Random Progression</a>

        <form method="post" class="d-inline-block my-1">
            <input type="hidden" asp-for="CurrentProgressionIndex" />
            <input type="hidden" asp-for="EnableStylizedPlayback" />
            <button type="submit" asp-page-handler="First" class="btn btn-secondary btn-lg mx-1">First</button>
        </form>

        <form method="post" class="d-inline-block my-1">
            <input type="hidden" asp-for="CurrentProgressionIndex" />
            <input type="hidden" asp-for="EnableStylizedPlayback" />
            <button type="submit" asp-page-handler="Previous" class="btn btn-info btn-lg mx-1">Previous</button>
        </form>

        <form method="post" class="d-inline-block my-1">
            <input type="hidden" asp-for="CurrentProgressionIndex" />
            <input type="hidden" asp-for="EnableStylizedPlayback" />
            <button type="submit" asp-page-handler="Next" class="btn btn-info btn-lg mx-1">Next</button>
        </form>

        <form method="post" class="d-inline-block my-1">
            <input type="hidden" asp-for="CurrentProgressionIndex" />
            <input type="hidden" asp-for="EnableStylizedPlayback" />
            <button type="submit" asp-page-handler="Last" class="btn btn-secondary btn-lg mx-1">Last</button>
        </form>

        <a asp-page="/Index" class="btn btn-secondary btn-lg mx-2 my-1">Back to Home</a>
    </div>
</div>

@section Scripts {
    <script src="~/js/soundfont-player.min.js"></script>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            const playButton = document.getElementById('playMidiButton');
            const loadingMessage = document.getElementById('loadingMessage');
            let pianoPlayer = null;
            let stringPlayer = null;
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();

            const stylizedMidiEvents = @Html.Raw(Json.Serialize(Model.StylizedProgression?.MidiEvents));

            const PIANO_PROGRAM = 0; // Acoustic Grand Piano
            const STRING_ENSEMBLE_PROGRAM = 48; // String Ensemble 1

            const PIANO_GAIN = 1.0; // Full volume for piano
            const STRING_GAIN = 0.3; // Reduced volume for strings

            // The base path for local soundfonts, pointing to the directory containing the .js files
            const LOCAL_SOUNDFONT_PATH = '/soundfonts/MusyngKite/'; // Corresponds to wwwroot/soundfonts/MusyngKite/

            // CORRECTED: Custom URL builder function for soundfont-player
            // We hardcode '-mp3.js' because the 'format' argument passed to this function
            // appears to be undefined in this specific usage context of soundfont-player.js.
            function buildLocalSoundfontUrl(name, /* format is undefined here */) {
                return LOCAL_SOUNDFONT_PATH + name + '-mp3.js';
            }


            if (playButton && stylizedMidiEvents && stylizedMidiEvents.length > 0) {
                playButton.addEventListener('click', async function () {
                    if (pianoPlayer === null || stringPlayer === null) {
                        loadingMessage.style.display = 'block';
                        playButton.disabled = true;
                        try {
                            [pianoPlayer, stringPlayer] = await Promise.all([
                                // Use nameToUrl to force loading from our custom local path
                                // The 'format: 'mp3'' option is still needed here for soundfont-player's
                                // internal logic, even if not directly used by buildLocalSoundfontUrl's arguments.
                                Soundfont.instrument(audioContext, 'acoustic_grand_piano', {
                                    format: 'mp3',
                                    nameToUrl: buildLocalSoundfontUrl // Pass our custom builder function
                                }),
                                Soundfont.instrument(audioContext, 'string_ensemble_1', {
                                    format: 'mp3',
                                    nameToUrl: buildLocalSoundfontUrl // Pass our custom builder function
                                })
                            ]);

                            loadingMessage.style.display = 'none';
                            playButton.disabled = false;
                            console.log("Instruments loaded successfully from local path: Piano and String Ensemble.");
                        } catch (error) {
                            console.error("Error loading soundfont instruments. Please double check: 1) local .js files are in 'wwwroot/soundfonts/MusyngKite/'. 2) Their names are exactly 'instrument_name-mp3.js'. 3) The 'format: 'mp3'' option is correct.", error);
                            loadingMessage.textContent = "Error loading instruments. Check console (F12).";
                            return;
                        }
                    }

                    if (pianoPlayer) pianoPlayer.stop();
                    if (stringPlayer) stringPlayer.stop();


                    stylizedMidiEvents.forEach(event => {
                        const safePitch = Math.max(0, Math.min(127, event.pitch));
                        let playerToUse;
                        let gainToApply = 1.0;

                        if (event.instrumentProgram === PIANO_PROGRAM) {
                            playerToUse = pianoPlayer;
                            gainToApply = PIANO_GAIN;
                        } else if (event.instrumentProgram === STRING_ENSEMBLE_PROGRAM) {
                            playerToUse = stringPlayer;
                            gainToApply = STRING_GAIN;
                        } else {
                            console.warn(`Unknown instrument program: ${event.instrumentProgram}. Defaulting to piano.`);
                            playerToUse = pianoPlayer;
                            gainToApply = PIANO_GAIN;
                        }

                        if (playerToUse) {
                            playerToUse.play(safePitch, audioContext.currentTime + event.startTime, { duration: event.duration, gain: gainToApply });
                        }
                    });
                });
            } else if (playButton) {
                playButton.disabled = true;
                playButton.textContent = "No MIDI to Play";
            }
        });
    </script>
}